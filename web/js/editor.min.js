function createButton(t){var e=$(t).attr("id"),a=$(t).children("legend").text();"*"===a.substr(-1)&&(a=a.substr(0,a.length-1));var n='<button type="button" onclick="removeFieldset(this);return false;" class="btn_delete">Remove this '+a+"</button>";$(t).children("legend").after(n);var i=e.substr(0,e.lastIndexOf("_")+1);if("_new"===e.substr(e.lastIndexOf("_"))){$(t).parents("form").data(e,$(t).clone()),$(t).hide();var n='<button type="button" onclick="$(this).scrollView();addFieldset(\''+e+'\', true);return false;" id="'+e+'_btn" class="btn_add">Add new '+a+'</button><hr class="afterbutton" />';$(t).after(n);var o=0;$("fieldset[data-repeatable][id^="+i+"new]").each(function(){nr=parseInt(this.id.substr(i.length+3)),nr>o&&(o=nr)}),$("#"+e+"_btn").data("suffix",o),$("fieldset[data-repeatable][id^="+i+"]:not([id^="+i+"new_])").length<=1&&addFieldset(e)}else nr=e.substr(e.lastIndexOf("_")+1),$(t).attr("data-map")&&(loadMap("#mapContainer_"+nr),"Area"===getFeatureType(nr)?""!==$("[name="+mapBaseId+"wkt_"+nr+"]").val()&&($("[name="+mapBaseId+"type_"+nr+"]:checked").data("wkt",$("[name="+mapBaseId+"wkt_"+nr+"]").val()),createFeature(nr,!1)):createFeature(nr,"wkt"))}function loadMap(t){var e=$(t).attr("id").split("_")[1],a=new ol.layer.Tile({source:new ol.source.OSM}),n=new ol.source.Vector({wrapX:!1}),i=new ol.layer.Vector({source:n,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(198,215,235,0.5)"}),stroke:new ol.style.Stroke({color:"#3b6daa",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#3b6daa"})})})}),o=new ol.View({center:[0,0],zoom:0,projection:"EPSG:3857"}),r=new ol.Map({layers:[a,i],target:$(t).attr("id"),view:o});$(t).data("source",n),$(t).data("vector",i),$(t).data("map",r),$(t).data("view",o),addInteraction(e),$("#mapContainer_"+e).data("source").on("addfeature",function(t){void 0!==$("#mapContainer_"+e).data("feature")&&$("#mapContainer_"+e).data("source").removeFeature($("#mapContainer_"+e).data("feature")),$("#mapContainer_"+e).data("feature",t.feature);var a=6,n=t.feature.getGeometry().getCoordinates();switch(wkt=new ol.format.WKT,wktString=wkt.writeFeature(t.feature,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}),$("[name="+mapBaseId+"wkt_"+e+"]").val(wktString),$("[name="+mapBaseId+"type_"+e+"]:checked").data("wkt",wktString),getFeatureType(e)){case"Area":var i=[],o=[];n[0].forEach(function(t){t=ol.proj.transform(t,"EPSG:3857","EPSG:4326"),i.push(t[0]),o.push(t[1])}),$("[name="+mapBaseId+"north_"+e+"]").val(Math.max.apply(Math,o).toFixed(a)),$("[name="+mapBaseId+"south_"+e+"]").val(Math.min.apply(Math,o).toFixed(a)),$("[name="+mapBaseId+"east_"+e+"]").val(Math.max.apply(Math,i).toFixed(a)),$("[name="+mapBaseId+"west_"+e+"]").val(Math.min.apply(Math,i).toFixed(a));break;case"Point":n=ol.proj.transform(n,"EPSG:3857","EPSG:4326"),$("[name="+mapBaseId+"latitude_"+e+"]").val(n[1].toFixed(a)),$("[name="+mapBaseId+"longitude_"+e+"]").val(n[0].toFixed(a))}}),$(".map input[name="+mapBaseId+"type_"+e+"]").each(function(){$(this).prop("checked")||$("#"+$(this).attr("value")).hide()}).on("change",function(){$("input[name="+$(this).attr("name")+"]").each(function(){$("#"+$(this).attr("value")).slideUp(duration)}),$("#"+$(this).attr("value")).slideDown(duration),$("#mapContainer_"+e).data("map").removeInteraction($("#mapContainer_"+e).data("draw")),addInteraction(e),createFeature(e,!1)}),$("#"+mapBaseId+"Area_"+e+" input, #"+mapBaseId+"Point_"+e+" input").on("change",function(){createFeature(e,!0)}),$("[name="+mapBaseId+"wkt_"+e+"]").on("change",function(){createFeature(e,"wkt")})}function addInteraction(t){var e=getFeatureType(t);if(void 0===e)$("#mapContainer_"+t).on("click",function(){npdc.alert("Please select type first")});else{$("#mapContainer_"+t).off("click");var a,n;"Area"===e&&(e="LineString",n=2,a=function(t,e){e||(e=new ol.geom.Polygon(null));var a=t[0],n=t[1];return e.setCoordinates([[a,[a[0],n[1]],n,[n[0],a[1]],a]]),e}),draw=new ol.interaction.Draw({source:$("#mapContainer_"+t).data("source"),type:e,geometryFunction:a,maxPoints:n}),$("#mapContainer_"+t).data("map").addInteraction(draw),$("#mapContainer_"+t).data("draw",draw)}}function getFeatureType(t){return str=$("[name="+mapBaseId+"type_"+t+"]:checked").val(),void 0!==str&&(str=str.substr(mapBaseId.length).split("_")[0]),str}function createFeature(t,e){if(getFeatureType(t),$("#mapContainer_"+t).data("source").clear(),$("#mapContainer_"+t).removeData("feature"),feature=void 0,"wkt"===e){var a=new ol.format.WKT;""!==$("[name="+mapBaseId+"wkt_"+t+"]").val()&&(feature=a.readFeature($("[name="+mapBaseId+"wkt_"+t+"]").val(),{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}),$("[name="+mapBaseId+"type_"+t+"]:checked").prop("checked",!1),$("[name="+mapBaseId+"type_"+t+"][value="+mapBaseId+feature.getGeometry().getType()+"_"+t+"]").prop("checked",!0))}else if(e)switch(getFeatureType(t)){case"Area":if($.isNumeric($("[name="+mapBaseId+"north_"+t+"]").val())&&$.isNumeric($("[name="+mapBaseId+"south_"+t+"]").val())&&$.isNumeric($("[name="+mapBaseId+"east_"+t+"]").val())&&$.isNumeric($("[name="+mapBaseId+"west_"+t+"]").val())){var n=parseFloat($("[name="+mapBaseId+"north_"+t+"]").val()),i=parseFloat($("[name="+mapBaseId+"south_"+t+"]").val()),o=parseFloat($("[name="+mapBaseId+"east_"+t+"]").val()),r=parseFloat($("[name="+mapBaseId+"west_"+t+"]").val());o<r&&(r-=360),feature=new ol.Feature({geometry:new ol.geom.Polygon([[ol.proj.transform([r,n],"EPSG:4326","EPSG:3857"),ol.proj.transform([o,n],"EPSG:4326","EPSG:3857"),ol.proj.transform([o,i],"EPSG:4326","EPSG:3857"),ol.proj.transform([r,i],"EPSG:4326","EPSG:3857"),ol.proj.transform([r,n],"EPSG:4326","EPSG:3857")]])})}break;case"Point":if($.isNumeric($("[name="+mapBaseId+"latitude_"+t+"]").val())&&$.isNumeric($("[name="+mapBaseId+"longitude_"+t+"]").val())){var l=parseFloat($("[name="+mapBaseId+"latitude_"+t+"]").val()),s=parseFloat($("[name="+mapBaseId+"longitude_"+t+"]").val());feature=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform([s,l],"EPSG:4326","EPSG:3857"))}),c=[s,l]}}else{var a=new ol.format.WKT;void 0!==$("[name="+mapBaseId+"type_"+t+"]:checked").data("wkt")?(feature=a.readFeature($("[name="+mapBaseId+"type_"+t+"]:checked").data("wkt"),{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}),$("[name="+mapBaseId+"wkt_"+t+"]").val($("[name="+mapBaseId+"type_"+t+"]:checked").data("wkt"))):$("[name="+mapBaseId+"wkt_"+t+"]").val("")}if(void 0!==feature){$("#mapContainer_"+t).data("source").addFeature(feature),$("#mapContainer_"+t).data("feature",feature);var d=ol.animation.zoom({duration:duration,resolution:$("#mapContainer_"+t).data("view").getResolution()}),p=ol.animation.pan({duration:duration,source:$("#mapContainer_"+t).data("view").getCenter()});$("#mapContainer_"+t).data("map").render(),setTimeout(function(){$("#mapContainer_"+t).data("map").beforeRender(p),$("#mapContainer_"+t).data("map").beforeRender(d),"point"===$("[name="+mapBaseId+"type_"+t+"]:checked").val().split("_")[1]?($("#mapContainer_"+t).data("view").setCenter(ol.proj.transform(c,"EPSG:4326","EPSG:3857")),$("#mapContainer_"+t).data("view").setZoom(5)):$("#mapContainer_"+t).data("view").fit($("#mapContainer_"+t).data("source").getExtent(),$("#mapContainer_"+t).data("map").getSize(),{maxZoom:5})},1),"wkt"===e&&($($("#mapContainer_"+t).data("source")).trigger("addfeature"),$("[name="+mapBaseId+"type_"+t+"]:checked").trigger("change"))}}function addFieldset(t,e){"undefined"==typeof e&&(e=!1),clone=$("#"+t).parents("form").data(t).clone();var a=$("#"+t+"_btn").data("suffix")+1;a>1&&(clone.removeClass("error"),clone.find("span.error").remove()),clone.attr("id",t+a),$("#"+t).data("map")?(clone.find("[id$=_new]").each(function(){$(this).attr("id",$(this).attr("id")+a)}),clone.find("[name$=_new]").each(function(){$(this).attr("name",$(this).attr("name")+a)}),clone.find("[value$=_new]").each(function(){$(this).attr("value",$(this).attr("value")+a)}),clone.find("[for$=_new]").each(function(){$(this).attr("for",$(this).attr("for")+a)})):(clone.find("[id^="+t+"]").each(function(){$(this).attr("id",$(this).attr("id").replace(t,t+a))}),clone.find("[name^="+t+"]").each(function(){$(this).attr("name",$(this).attr("name").replace(t,t+a))}),clone.find("[name^=unit_"+t+"]").each(function(){$(this).attr("name",$(this).attr("name").replace(t,t+a))}),clone.find("[value^="+t+"]").each(function(){$(this).attr("value",$(this).attr("value").replace(t,t+a))}),clone.find("[for^="+t+"]").each(function(){$(this).attr("for",$(this).attr("for").replace(t,t+a))}),clone.find(".lookuptable,.multivalue").each(function(){if($(this).data("newRowBaseId",$(this).find("[id$=_row_new]").attr("id")),$(this).data("clone",$("#"+$(this).data("newRowBaseId")).clone()),$(this).data("newCount",-1),$(this).find("[id*=_row_new_]").each(function(){var t=parseInt($(this).attr("id").substring($(this).attr("id").lastIndexOf("_")+1));t>$(this).parents("table").data("newCount")&&$(this).parents("table").data("newCount",t)}),$(this).hasClass("single")){var t=$(this).find("td");single=!0}else var t=$(this).find("[id$=_row_new]");$(this).hasClass("lookuptable")&&($(window).keydown(function(t){if(13===t.keyCode&&lookup.cur>-1)return t.preventDefault(),!1}),initialize.lookuptable(t,$(this).hasClass("single")))}),clone.find(".counter").remove(),clone.find("input[maxlength],textarea[maxlength]").each(function(){var t=$(this).attr("name"),e=$(this).val().length,a=$(this).attr("maxlength"),n=a-e;$(this).after('<span class="counter">You have <span  id="cnt'+t+'">'+n+"</span> of "+a+" characters remaining</span>").keyup(function(){var t=$(this).attr("name"),e=$(this).val().length,a=$(this).attr("maxlength");if(e>0&&$(this).is("[data-permitted-chars]")){var n=new RegExp("^["+$(this).attr("data-permitted-chars")+"]{0,}$");if(!n.test($(this).val())){var i=$(this).attr("data-permitted-chars");i="^"===i.substr(0,1)?i.substr(1):"^"+i,regex=new RegExp("["+i+"]","g");var o=$(this).val().replace(regex,"");$(this).val(o),e=o.length}}var r=a-e;$("#cnt"+t).html(r)})})),clone.find(".fieldset").each(function(){$(this).on("click",function(){$(this).hasClass("hidden")?($(this).nextUntil("hr").not("[id$=_new]").slideDown(),$(this).removeClass("hidden")):($(this).addClass("hidden"),$(this).nextUntil("hr").not("[id$=_new]").slideUp())})}),clone.find("input[data-inputmask]").inputmask();var n=clone.find("input[type!=hidden]:first").attr("name");$("#"+t+"_btn").before(clone),clone.find("fieldset[data-repeatable]").each(function(){createButton(this)}),$("body").find("#"+t+a+" select:not(.no-select2):not(.select2-hidden-accessible)").each(function(){makeSelect2(this)}),$("#"+t+"_btn").data("suffix",a),$("#"+t).attr("data-map")&&loadMap("#mapContainer_new"+a),e&&$("input[name="+n+"]").focus()}function removeFieldset(t){$(t).parent("fieldset").siblings(":visible").fadeTo(0,.25),$(t).parent("fieldset").css("box-shadow","0 0 10px black"),$(t).parent("fieldset").children("legend").hide();var e=$(t).parent("fieldset").children("legend").text();"*"===e.substr(-1)&&(e=e.substr(0,e.length-1)),npdc.confirm("Do you really want to remove this "+e+"?","Remove "+e,function(){form=$(t).parents("form"),$(t).parent("fieldset").siblings(":visible").fadeTo(200,1);var e=$(t).parents("fieldset").attr("id");0===$(t).parent("fieldset").siblings("fieldset[id^="+e.substring(0,e.lastIndexOf("_")+1)+"]:visible").length&&addFieldset(e.substring(0,e.lastIndexOf("_")+1)+"new"),$(t).parent("fieldset").remove()},"Keep "+e,function(){$(t).parent("fieldset").siblings(":visible").fadeTo(200,1),$(t).parent("fieldset").css("box-shadow",""),$(t).parent("fieldset").children("legend").show()})}function disableFieldset(t){var e=0;""!==t.val()&&"MAX_FILE_SIZE"!==t.attr("name")&&e++,t.siblings(":input").each(function(){""!==$(this).val()&&"MAX_FILE_SIZE"!==$(this).attr("name")&&e++}),void 0!==t.parent("fieldset").attr("data-max")&&(e>=t.parent("fieldset").attr("data-max")?t.siblings(":input").addBack().each(function(){""===$(this).val()&&$(this).prop("disabled",!0)}):t.siblings(":input").prop("disabled",!1))}function removeFile(t){npdc.confirm("Are you sure you want to delete this file?","Yes, delete",function(){$("input[name=keepfile_"+t+"]").val(""),$("input[name="+t+"]").prop("disabled",!1),$("#uploaded_"+t).remove(),1===$("input[name="+t+"]").parent("fieldset").length&&disableFieldset($("input[name="+t+"]"))},"No, keep")}function decodeEntities(t){var e=document.createElement("textarea");return e.innerHTML=t,e.value}function closeOverlay(t){if(void 0!==t)switch($("#overlay").data("type")){case"select2":var e=new Option(t.label,t.id,!0,!0);$($("#overlay").data("element")).append(e).trigger("change");break;case"lookupfield":lookup.saveOption($("#overlay").data("element"),t.id,decodeEntities(t.label),t.nextfield,!1)}$("form :input").prop("disabled",!1),$("#overlay").hide(),$("a, button, input").removeAttr("tabindex"),$("a[data-tabindex], button[data-tabindex], input[data-tabindex]").each(function(){$(this).attr("tabindex",$(this).attr("data-tabindex"))}),$("iframe").contents().find("a, button, input").removeAttr("tabindex"),$("iframe").contents().find("a[data-tabindex], button[data-tabindex], input[data-tabindex]").each(function(){$(this).attr("tabindex",$(this).attr("data-tabindex"))})}function makeSelect2(t){placeholder="",$(t).children("option").each(function(){"please_select"===$(this).val()&&(placeholder=$(this).html(),$(this).after("<option></option>"),$(this).remove())});var e={placeholder:placeholder,minimumResultsForSearch:10};$(t).hasClass("error")&&(e.containerCssClass="error"),$(t).siblings(".no_select2").remove(),e.placeholder="Type here to select one or more options",void 0!==$(t).attr("data-ajax-url")&&(e.ajax={url:$(t).attr("data-ajax-url"),dataType:"json",delay:250,data:function(e){return{q:e.term,output:"object",add:void 0!==$(t).attr("data-new-url")}},escapeMarkup:function(t){return t},minimumInputLength:2,processResults:function(t){return{results:t.items}}},e.templateResult=function(t){return t.text},e.templateSelection=function(t){return t.text}),void 0!==$(t).attr("data-new-url")?(e.placeholder="Type here to select an option or add a new one",e.tags=!0,e.minimumResultsForSearch=1,e.createSearchChoice=function(t){return{id:"new",text:"Add "+t.term}},e.createTag=function(t){return{id:"new",text:"Add "+t.term}},e.insertTag=function(t,e){t.push(e)},$(t).select2(e).on("select2:selecting",function(t){"new"===t.params.args.data.id&&(t.preventDefault(),name=t.params.args.data.text.substring(4),$("form :input").prop("disabled",!0),$("#overlay .inner").html('<iframe src="'+$(this).attr("data-new-url")+"/"+name+'"></iframe>'),$("#overlay").show(),$("#overlay").data("element",$(this)),$("#overlay").data("type","select2"),$(this).select2("close"))})):$(t).select2(e)}function cloneLine(t){var e=$(t).parent().clone(),a=$(t).parents("table");e.find("input").val(""),a.data("newCount",a.data("newCount")+1),suffix="_"+a.data("newCount"),a.find("[id$=_new]").each(function(){$(this).attr("id",$(this).attr("id")+suffix)}),a.find("[name$=_new]").each(function(){$(this).attr("name",$(this).attr("name")+suffix)}),a.find("[for$=_new]").each(function(){$(this).attr("for",$(this).attr("for")+suffix)}),a.find("#"+a.data("newRowBaseId")+suffix+" td:nth-child(2)").click(function(){lookup.delete($(this).parent().attr("id"))}),$(t).parent().after(e),"true"===a.attr("data-sortable")&&(a.data("ui-sortable")?a.sortable("refresh"):a.sortable({items:"tbody tr:not(:last-child)"})),$("#"+a.data("newRowBaseId")+" select:not(.no-select2):not(.select2-hidden-accessible)").each(function(){makeSelect2(this)})}function doubleTitle(t){"publication_new"==$('input[name="formid"]').val()&&(url=baseUrl+"/lookup/publication?fuzzy&q="+$('input[name="'+t+'"]').val(),$.ajax(url).done(function(t){0!=t&&(1==t.length?alert="A publication with a similar title has been found. Please check if this is a different publication. If so, please proceed with adding your publication.":alert="Several publications with similar titles have been found. Please check if these are different publications. If so, please proceed with adding your publication",$.each(t,function(t,e){alert=alert+'<br/><a href="'+baseUrl+"/publication/"+t+'">- '+e+"</a>"}),npdc.alert(alert))}))}function doubleDOI(t){"publication_new"==$('input[name="formid"]').val()&&(url=baseUrl+"/lookup/publication?doi="+$('input[name="'+t+'"]').val(),$.ajax(url).done(function(t){console.log(t),0!=t&&npdc.alert('There is alreay a publication with this DOI. You can find it <a href="'+baseUrl+"/publication/"+t.publication_id+"\">here</a>. If the site indicates you don't have permission to view it or it appears to be a different publication please contact the NPDC")}))}var lookup,lookupfield,clone,duration=200,mapBaseId="spatial_coverage_",initialize;$().ready(function(){npdc={alert:function(t){$("#overlay .inner").addClass("box").html(t),$("#overlay .inner").append('<br/><br/><button onclick="npdc.close();">OK</button>'),$("#overlay").fadeIn(100,function(){$(window).on("keyup",function(t){var e=t.keyCode||t.which;13!==e&&27!==e||npdc.close()})})},confirm:function(t){for($("#overlay .inner").addClass("box").text(t),$("#overlay .inner").append("<br/><br/>"),i=1;i<arguments.length;i+=2)$("#overlay .inner").append('<button id="btn'+(i+1)/2+'">'+arguments[i]+"</button> ");for($("#overlay .inner.box button").on("click",function(){npdc.close()}),args=arguments,i=2;i<arguments.length;i+=2)$("#btn"+i/2).on("click",arguments[i]);$("#overlay").fadeIn(100,function(){$(window).on("keydown",function(t){t.preventDefault()}),$(window).on("keyup",function(t){var e=t.keyCode||t.which;13===e&&args.length<=5&&(npdc.close(),args[2]()),27===e&&(npdc.close(),args.length%2===1&&args[args.length-1]())})})},close:function(t){$(window).off("keydown keyup"),$("#overlay").fadeOut(100,function(){$("#overlay .inner").removeClass("box").text("")})}},(window.navigator.userAgent.indexOf("MSIE ")>0||navigator.userAgent.match(/Trident.*rv\:11\./))&&npdc.alert("We see you are using Internet Explorer. Due to some bugs specific to Internet Explorer we recommend using a different browser such as Edge, Google Chrome or Firefox"),$("td").has("input[type=checkbox]").click(function(){$(this).children("input").prop("checked",!$(this).children("input").prop("checked"))}),$("td").has("input[type=radio]").click(function(){$(this).children("input").prop("checked",!0)}),$('[data-freetext="this"]').each(function(){input=$(this).siblings("input").last(),"new"!==$(input).attr("name").split("_").pop()&&"quickadd"==$(input).val()&&($(this).children("input").removeAttr("readonly").removeClass("readonly"),$(this).siblings('[data-freetext="hide"]').data("oldHtml",$(this).siblings('[data-freetext="hide"]').html()).text(""),$(this).addClass("fuzzy-name"),$(this).append(' <span class="icon-search"></span>'))}),$(".fuzzy-name span").click(function(){var t=$(this).parents("table").attr("data-base-url")+"/lookup/"+$(this).parents("table").attr("data-lookup-url")+"?fuzzy&q="+$(this).siblings("input").val();$("[name^="+$(this).parents("table").attr("data-target-field")+"]").each(function(){""!==$(this).val()&&$.isNumeric($(this).val())&&(t+="&e[]="+$(this).val())}),fuzzyCaller=$(this).siblings("input").attr("name"),$.ajax(t).done(function(t){l=t.length,l>0?($("#overlay .inner").addClass("box").text("Please select an option below or click cancel"),$.each(t,function(t,e){$("#overlay .inner").append('<button class="choice" style="width:100%" data-id="'+e[0]+'" data-name="'+e[1]+'" data-org="'+e[2]+'">'+e[1]+"</button><br/>")}),$("#overlay .inner").append('<button onclick="npdc.close();">Cancel</button>'),$("#overlay .box button.choice").on("click",function(){$("#overlay .box button.choice").off("click");var t=$("input[name="+fuzzyCaller+"]");if(t.val($(this).attr("data-name")).addClass("readonly").attr("readonly","readonly").parent().removeClass("fuzzy-name").find("span").remove(),$("input[name="+fuzzyCaller.replace(t.parents("table").attr("data-source-field"),t.parents("table").attr("data-target-field"))+"]").val($(this).attr("data-id")),void 0!==t.attr("data-onsubmit")){var e=$("select[name="+fuzzyCaller.replace(t.parents("table").attr("data-source-field"),t.attr("data-onsubmit"))+"]"),a=$(this).attr("data-org");void 0!==e.attr("data-ajax-url")&&(e.addClass("ajax-target"),$.get(e.attr("data-ajax-url")+"/"+$(this).attr("data-org"),function(t){$(".ajax-target").append($("<option>",{value:t[0][0]}).text(t[0][1].replace("&amp;","&"))),$(".ajax-target").val(a).trigger("change"),$(".ajax-target").removeClass("ajax-target")})),t.parent().siblings('[data-freetext="hide"]').html(t.parent().siblings('[data-freetext="hide"]').data("oldHtml")),npdc.close()}}),$("#overlay").fadeIn(100,function(){$(window).on("keyup",function(t){var e=t.keyCode||t.which;13!==e&&27!==e||npdc.close()})})):npdc.alert("No match found")})}),lookup={add:function(t){t.data("newCount",t.data("newCount")+1),suffix="_"+t.data("newCount"),t.find("[id$=_new]").each(function(){$(this).attr("id",$(this).attr("id")+suffix)}),t.find("[name$=_new\\[\\]]").each(function(){$(this).attr("name",$(this).attr("name").slice(0,-2)+suffix+"[]")}),t.find("[name$=_new]").each(function(){$(this).attr("name",$(this).attr("name")+suffix)}),t.find("[for$=_new]").each(function(){$(this).attr("for",$(this).attr("for")+suffix)}),t.find("#"+t.data("newRowBaseId")+suffix+" td:nth-child(2)").click(function(){lookup.delete($(this).parent().attr("id"))}),clone=t.data("clone"),t.data("clone",clone.clone()),clone.insertAfter($("#"+t.data("newRowBaseId")+suffix)),$("#"+t.data("newRowBaseId")+" select:not(.no-select2):not(.select2-hidden-accessible)").each(function(){makeSelect2(this)}),t.hasClass("lookuptable")&&initialize.lookuptable(clone)},delete:function(t){var e=$("#"+t).parents("table"),a=$("#"+t).find("td:nth-of-type("+e.attr("data-n-label")+")").find("input");a.parents("form");npdc.confirm("Do you want to delete "+a.val()+" here?","Yes, delete",function(){$("#"+t).remove()},"No, keep")},updateField:function(t){tbl=$(t).parents("table"),"new"===$(t).attr("value")&&void 0!==$(t).parents("table").attr("data-new-url")?(name=$(t).text().replace(/^Add '|' with details$|'$/g,""),$("#overlay .inner").html('<iframe src="'+$(t).parents("table").attr("data-new-url")+"/"+name+"?ref="+controller+'"></iframe>'),$("#overlay").show(),$("form :input").prop("disabled",!0),$("#overlay").data("element",tbl),$("#overlay").data("type","lookupfield")):("quickadd"===$(t).attr("value")&&($(t).text($(t).text().replace(/^Quickly add '|' \(without details\)$/g,"")),$(t).attr("value","quickadd"),$(t).parents("td").siblings('td[data-freetext="hide"]').text("")),this.saveOption(tbl,$(t).attr("value"),$(t).text(),$(t).attr("data-nextfield"),"quickadd"==$(t).attr("value")))},saveOption:function(t,e,a,n,i){if(t.hasClass("single"))$(t).data("lookupfield").val(a).siblings("input[type=hidden]").val(e),$(t).data("lookupfield").attr("readonly","readonly").addClass("readonly"),i||t.data("lookupfield").off("keyup keydown focus");else{if($("[name="+t.attr("data-source-field")+"_new]").val(a),i||$("[name="+t.attr("data-source-field")+"_new]").attr("readonly","readonly").addClass("readonly"),$("[name="+t.attr("data-target-field")+"_new]").val(e),t.data("lookupfield").off("keyup keydown focus"),void 0!==$("[name="+t.attr("data-source-field")+"_new]").attr("data-onsubmit")&&void 0!==n){var o=$("[name="+t.attr("data-source-field")+"_new]").attr("data-onsubmit");void 0!==$("[name="+o+"_new]").attr("data-ajax-url")&&($("[name="+o+"_new]").addClass("ajax-target"),$.get($("[name="+o+"_new]").attr("data-ajax-url")+"/"+n,function(t){$(".ajax-target").append($("<option>",{value:t[0][0]}).text(t[0][1].replace("&amp;","&"))),$(".ajax-target").val(n).trigger("change"),$(".ajax-target").removeClass("ajax-target")})),$("[name="+o+"_new]").val(n).trigger("change")}lookup.add(t)}$("#optionwrapper").remove(),form=$(t).parents("form")},selectOption:function(t,e){if(e="undefined"!=typeof e&&e,clearTimeout(lookup.timer),fullString=$(t).attr("data-self"),$(t).hasClass("notSelected"))for($("#optionwrapper div").removeClass("clicked").addClass("notSelected hidden"),$("#optionwrapper :not([data-parent])").removeClass("hidden"),$(t).removeClass("notSelected hidden"),testElement=t;$(testElement).is("[data-parent]");)$('[data-parent="'+$(testElement).attr("data-parent")+'"]').removeClass("hidden"),testElement='[data-self="'+$(testElement).attr("data-parent")+'"]',$(testElement).removeClass("notSelected").addClass("clicked");if($(t).hasClass("clicked")||0===$('div[data-parent="'+fullString+'"]').length||e){if(void 0===$(t).attr("data-parent"))$(t).text($(t).text());else{truncated=[],$(t).attr("data-parent").split(">").forEach(function(t){t.trim().length>12?truncated.push(t.trim().substring(0,10)+"..."):truncated.push(t.trim())});var a=$(t).text().trim();lof=a.lastIndexOf(">"),lof>-1&&(a=a.substring(lof).trim()),$(t).text(truncated.join(" > ")+" "+a)}lookup.updateField(t)}else $(t).addClass("clicked"),$(t).siblings(":not(.clicked)").addClass("notSelected"),$('[data-parent="'+fullString+'"]').removeClass("hidden notSelected"),lookup.scrollOptionwrapper(!0)},positionOptionwrapper:function(){if($("#optionwrapper").length>0){var t=$("#optionwrapper").prev("input").offset().top,e=document.documentElement.scrollTop,a=$(window).height();t-e>a/2?($("#optionwrapper").css("max-height",t-e).css("bottom",$("#optionwrapper").parent().height()),$("#optionwrapper").addClass("above")):($("#optionwrapper").css("max-height",a-30-(t-e)).css("bottom","auto"),$("#optionwrapper").removeClass("above"))}},scrollOptionwrapper:function(t){lookup.cur!==-1&&(t?$("#option_"+lookup.cur).parent().scrollTop($("#option_"+lookup.cur).parent().scrollTop()+$("#option_"+lookup.cur).position().top-15):$("#option_"+lookup.cur).position().top<0?$("#option_"+lookup.cur).parent().scrollTop($("#option_"+lookup.cur).parent().scrollTop()+$("#option_"+lookup.cur).position().top-15):$("#option_"+lookup.cur).position().top>$("#option_"+lookup.cur).parent().height()-30&&$("#option_"+lookup.cur).parent().scrollTop($("#option_"+lookup.cur).parent().scrollTop()+$("#option_"+lookup.cur).position().top-$("#option_"+lookup.cur).parent().height()+40))}},initialize={lookuptable:function(t,e){if(e)var a=$(t).find("input[type=text]");else var a=$("input[name="+t.parents("table").attr("data-source-field")+"_new]");a.parents("table").find(".lookupwrapper").removeClass("lookupwrapper"),a.parent().addClass("lookupwrapper"),a.cur=null,a.parents("table").data("lookupfield",a),a.on("keydown keyup focus paste",function(t){var e=t.keyCode||t.which;if((13===e||9===e||"keydown"!==t.type)&&(13!==e&&9!==e||"keyup"!==t.type)){var n=a.val();if(n!==a.cur||"focus"===t.type&&0===$(this).next("#optionwrapper").length){if($("#optionwrapper").remove(),n.length>=2,!0){var i=a.parents("table").attr("data-base-url")+"/lookup/"+a.parents("table").attr("data-lookup-url")+"?q="+n;$("[name^="+a.parents("table").attr("data-target-field")+"]").each(function(){""!==$(this).val()&&$.isNumeric($(this).val())&&(i+="&e[]="+$(this).val())}),$.ajax(i).done(function(t){n===a.val()&&($("#optionwrapper").remove(),optionlist=[],options='<div id="optionwrapper" class="options"></div>',a.after(options),lookup.positionOptionwrapper(),l=t.length,lookup.data=t,lookup.cur=-1,l>0?$.each(t,function(t,e){displayValue=e[1],parent=e[1].substring(0,e[1].lastIndexOf(">")).trim(),a.cur.length>0?displayValue=e[1].replace(new RegExp("("+a.cur+")","gi"),"<mark>$1</mark>"):0===parent.length?parent=void 0:displayValue=(e[1].match(/>/g).join("").replace(/>/g,"   ")||[])+e[1].substring(e[1].lastIndexOf(">")).trim();var n=$("<div>").html(displayValue).attr("id","option_"+t).attr("value",e[0]).attr("data-parent",parent).attr("data-self",e[1]);e.length>2&&n.attr("data-nextfield",e[2]),$("#optionwrapper").append(n)}):$("#optionwrapper").append($("<div>").html("<i>No results found</i>")),void 0!==$("#optionwrapper").parents("table").attr("data-new-url")&&($("#optionwrapper").append($("<div>").html("<i>Add '"+$("#optionwrapper").siblings("input").val()+"'"+("this"===$("#optionwrapper").parent("td").attr("data-freetext")?" with details":"")+"</i>").attr("id","option_"+l).attr("value","new")),l+=1),"this"===$("#optionwrapper").parent("td").attr("data-freetext")&&($("#optionwrapper").append($("<div>").html("<i>Quickly add '"+$("#optionwrapper").siblings("input").val()+"' (without details)</i>").attr("id","option_"+l).attr("value","quickadd")),l+=1),$("#optionwrapper div[value]").on("mouseenter",function(){lookup.cur=Number($(this).attr("id").split("_")[1]),$(".optionHasFocus").removeClass("optionHasFocus"),$("#option_"+lookup.cur).addClass("optionHasFocus")}),0===n.length?($("#optionwrapper div[data-parent]").addClass("hidden"),$("#optionwrapper div").on("click",function(){lookup.cur=Number($(this).attr("id").split("_")[1]),$(".optionHasFocus").removeClass("optionHasFocus"),$("#option_"+lookup.cur).addClass("optionHasFocus"),lookup.selectOption(this),$("#optionwrapper").prev("input").focus()}).on("mousedown",function(t){t.preventDefault()})):$("#optionwrapper div[value]").off("click").on("click",function(){lookup.cur=Number($(this).attr("id").split("_")[1]),$(".optionHasFocus").removeClass("optionHasFocus"),$("#option_"+lookup.cur).addClass("optionHasFocus"),lookup.selectOption(this,!0)}).on("mousedown",function(t){t.preventDefault()}))})}a.cur=n}else switch(e){case 40:return t.preventDefault(),lookup.cur===-1?lookup.cur=0:(nextId=$("#optionwrapper div:not(.hidden)").eq($("#optionwrapper div:not(.hidden)").index($(".optionHasFocus"))+1).attr("id"),void 0===nextId?lookup.cur=-1:lookup.cur=Number(nextId.substr(nextId.lastIndexOf("_")+1))),$(".optionHasFocus").removeClass("optionHasFocus"),$("#option_"+lookup.cur).addClass("optionHasFocus"),lookup.scrollOptionwrapper(),!1;case 38:return t.preventDefault(),lookup.cur===-1?(prevId=$("#optionwrapper div:not(.hidden)").last().attr("id"),lookup.cur=Number(prevId.substr(prevId.lastIndexOf("_")+1))):(prevId=$("#optionwrapper div:not(.hidden)").eq($("#optionwrapper div:not(.hidden)").index($(".optionHasFocus"))-1).attr("id"),0===$("#optionwrapper :not(.hidden)").index($(".optionHasFocus"))?lookup.cur=-1:lookup.cur=Number(prevId.substr(prevId.lastIndexOf("_")+1))),$(".optionHasFocus").removeClass("optionHasFocus"),$("#option_"+lookup.cur).addClass("optionHasFocus"),lookup.scrollOptionwrapper(),!1;case 13:case 9:t.preventDefault(),lookup.cur>-1&&lookup.selectOption($("#option_"+lookup.cur));break;case 27:lookup.doBlur()}}}),lookup.doBlur=function(){if(document.hasFocus()&&$("#overlay").is(":not(:visible)"))if("undefined"!=typeof $("#optionwrapper").siblings("input").val()&&$("#optionwrapper").siblings("input").val().length>0){var t="Please select a value from the options";void 0!==$("#optionwrapper").parents("table").attr("data-new-url")&&(t+=" or use the add new option"),npdc.confirm(t,"Continue selecting",function(){setTimeout(function(){$("#optionwrapper").siblings("input").focus()},100)},"Cancel and remove input",function(){$("#optionwrapper").siblings("input").val(""),$("#optionwrapper").hide()})}else $("#optionwrapper").hide()},a.blur(function(){lookup.timer=setTimeout(function(){lookup.doBlur()},10)}),a.focus(function(){$("#optionwrapper").show(),lookup.positionOptionwrapper()})}},$.expr[":"].focus=function(t){return t===document.activeElement},multitext={init:function(t,e){var a=t.keyCode||t.which;if(!("keydown"===t.type&&[9,13,188].indexOf(a)<0||(13===a||9===a)&&"keyup"===t.type))switch(""===$(e).val()?$(e).siblings("button").prop("disabled",!0).off("click"):$(e).siblings("button").prop("disabled",!1).on("click",function(t){t.preventDefault(),multitext.add(e)}),a){case 13:case 188:t.preventDefault();case 9:this.add(e)}},add:function(t){if(""!==$(t).val()){$(t).siblings("button").prop("disabled",!0).off("click"),val=$(t).val(),val.indexOf(",")>-1?val=val.split(","):val.indexOf(";")>-1?val=val.split(";"):val=[val];for(var e=0;e<val.length;e++)subval=val[e].trim(),
$(t).parent().siblings(".values").append('<span><input type="hidden" name="'+$(t).attr("name")+'" value="'+subval+'">'+subval+'<span class="delete">x</span></span>'),$(t).parent().siblings(".values").children(":last-of-type").children(".delete").on("click",function(){multitext.delete(this)});$(t).val("")}},delete:function(t){npdc.confirm("Realy delete "+$(t).siblings("input").val()+"?","Delete "+$(t).siblings("input").val(),function(){form=$(t).parents("form"),$(t).parent().remove()},"Keep "+$(t).siblings("input").val())}},$(".multitext button").prop("disabled",!0),$(".multitext .delete").on("click",function(){multitext.delete(this)}),$(".multitext input").on("keydown keyup",function(t){multitext.init(t,this)}),$(".lookuptable tbody tr:not(:last-child) td:nth-child(2), .multivalue tbody tr:not(:last-child) td:nth-child(2)").click(function(){lookup.delete($(this).parents("tr").attr("id"))}),$(".lookuptable,.multivalue").each(function(){$(this).hasClass("noAdd")&&($(this).find("[id$=_new]").hide(),0===$(this).find("tbody tr:visible").length&&($(this).hide(),$(this).next(".hint").hide())),"true"===$(this).attr("data-sortable")?($(this).sortable({items:"tbody tr:not(:last-child)"}),$(this).find("tbody td:first-child").on("touchstart",function(){npdc.alert("Sorting is only possible using a mouse")}),$(this).hasClass("multivalue")&&$(this).after("The last line can be left empty, to sort the last line add a new line below it using the + at the start of the line")):$(this).hasClass("single")||($(this).find("tbody tr td:first-child").hide(),$(this).find("td:first-child").attr("colspan",1))}),$("fieldset").each(function(){void 0===$(this).attr("data-min")&&void 0===$(this).attr("data-max")||($(this).children(":input").change(function(){disableFieldset($(this))}),disableFieldset($(this).children(":input:first")))}),$("input[maxlength],textarea[maxlength]").each(function(){var t=$(this).attr("name"),e=$(this).val().length,a=$(this).attr("maxlength"),n=a-e;$(this).after('<span class="counter">You have <span  id="cnt'+t+'">'+n+"</span> of "+a+" characters remaining</span>").keyup(function(){var t=$(this).attr("name"),e=$(this).val().length,a=$(this).attr("maxlength");if(e>0&&$(this).is("[data-permitted-chars]")){var n=new RegExp("^["+$(this).attr("data-permitted-chars")+"]{0,}$");if(!n.test($(this).val())){var i=$(this).attr("data-permitted-chars");i="^"===i.substr(0,1)?i.substr(1):"^"+i,regex=new RegExp("["+i+"]","g");var o=$(this).val().replace(regex,"_");$(this).val(o),e=o.length}}var r=a-e;$("#cnt"+t).html(r)})}),$("input[data-permitted-chars],textarea[data-permitted-chars]").not("[maxlength]").keyup(function(){if($(this).val().length>0){var t=new RegExp("^["+$(this).attr("data-permitted-chars")+"]{0,}$");if(!t.test($(this).val())){var e=$(this).attr("data-permitted-chars");e="^"===e.substr(0,1)?e.substr(1):"^"+e,regex=new RegExp("["+e+"]","g");var a=$(this).val().replace(regex,"");$(this).val(a)}}}),$(".lookuptable,.multivalue").each(function(){var t=!1;if($(this).hasClass("single")){var e=$(this).find("td");t=!0}else{$(this).data("newRowBaseId",$(this).find("[id$=_row_new]").attr("id")),$(this).data("clone",$("#"+$(this).data("newRowBaseId")).clone()),$(this).data("newCount",-1),$(this).find("[id*=_row_new_]").each(function(){var t=parseInt($(this).attr("id").substring($(this).attr("id").lastIndexOf("_")+1));t>$(this).parents("table").data("newCount")&&$(this).parents("table").data("newCount",t)});var e=$(this).find("[id$=_row_new]")}$(this).hasClass("lookuptable")&&initialize.lookuptable(e,t)}),$(window).on("scroll resize",function(){lookup.positionOptionwrapper()}),$("fieldset[data-repeatable]").each(function(){createButton(this),$(this).parents("form").data("serialized",$(this).parents("form").serialize())}),$("body.edit select:not(.no-select2):not(.select2-hidden-accessible)").each(function(){makeSelect2(this)}),$('body.edit form[action$="new"], body.edit form[action$="edit"]').submit(function(t){t.preventDefault(),t.returnValue=!1;var e=$(this);$.ajax({type:"post",url:baseUrl+"/lookup/session",context:e,success:function(){this.off("submit"),this.submit()},error:function(){openOverlay(baseUrl+"/login?notice=expired"),waitingForm=this}})}),fileHandler={showTable:function(t){$("#"+t).parents("table").show(),$("#"+t).parents("table").next(".hint").show()},hideTable:function(t){1===$("#"+t+" > tbody > tr").length&&($("#"+t).parents("table").hide(),$("#"+t).parents("table").next(".hint").hide())}},$("input[type=file][multiple]").on("change",function(){var t=$(this).attr("name").replace("[]","")+"_row_new";for(size=0,i=0;i<$(this)[0].files.length;++i)clone=$("#"+t).clone(),clone.find("[name=file_file_new]").val($(this)[0].files[i].name),clone.attr("id",clone.attr("id")+"_"+i),clone.find("[name]").each(function(){$(this).attr("name",$(this).attr("name")+"_"+i)}),clone.insertBefore("#"+t),clone.show(),size+=$(this)[0].files[i].size;fileHandler.showTable(t),$(this).off("click"),size>$("[name=MAX_FILE_SIZE]").val()?($("[id^="+t+"_]").remove(),fileHandler.hideTable(t),1===$(this)[0].files.length?npdc.alert("The file is too large, please contact the NPDC to add this file"):npdc.alert("The combined size of the files is too large, please select fewer files to stay under the size limit"),$(this).val("")):$(this).on("click",function(){return 0!==$("[id^="+t+"_]").length?(field=$(this),npdc.confirm("When selecting new files previously selected files will not be uploaded. Are you sure you wish to select new files to upload?","Yes, select new files to upload",function(){$("[id^="+t+"_]").remove(),fileHandler.hideTable(t),field.val(""),field.trigger("click")},"No, keep current files"),!1):($("[id^="+t+"_]").remove(),fileHandler.hideTable(t),$(this).val(""),void 0)})}),$(".suggestions:not(.show) li:not(:first-child)").hide(),$(".suggestions li:first-child").on("click",function(){$(this).parent().hasClass("show")?($(this).parent().removeClass("show"),$(this).siblings().slideUp()):($(this).parent().addClass("show"),$(this).siblings().slideDown())}),$(".suggestions li:not(:first-child)").on("click",function(){doSet=!1,0===$("textarea[name="+$(this).parent().attr("data-target")+"]").val().length&&(doSet=!0),doSet||(target=$(this).parent().attr("data-target"),value=$(this).text(),npdc.confirm("Do you want to replace '"+$("textarea[name="+$(this).parent().attr("data-target")+"]").val()+"' with '"+$(this).text()+"' in '"+$($(this).parent().prevAll("h4")[0]).text().replace("*","")+"'?","Yes, replace the text",function(){$("textarea[name="+target+"]").val(value)},"No, keep the old value")),doSet&&$("textarea[name="+$(this).parent().attr("data-target")+"]").val($(this).text())}),$("textarea[data-tags]").each(function(){switch($(this).attr("data-tags")){case"extended":var t=["html","|","bold","italic","underline","|","p","h1","h2","h3","|","subscript","superscript","|","link","unlink"];break;case"default":var t=["html","|","bold","italic","underline","|","p","h4","h5","h6","|","subscript","superscript","|","link","unlink"]}$(this).htmlarea({css:baseUrl+"/css/textarea.css",toolbar:t})})}),$.fn.scrollView=function(){return this.each(function(){$("html, body").animate({scrollTop:$(this).offset().top-100},500)})};